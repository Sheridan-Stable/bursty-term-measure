---
title: "Bursty Term P-value Estimation on GENIA Corpus Dataset"
author: "Paul Sheridan"
output: html_notebook
---

## Notation

Variables of note:

  * term[i] = i'th term in vocabulary
  * doc[[j]] = j'th doc in collection (unique terms)
  * d = number of documents in the collection
  * m = vocabulary size
  * n = total number of terms in the collection (including multiplicities) 
  * nij[[j]][i] = total number of occurrences of term[i] in doc[[j]]
  * ni[i] = total number of occurrences of term[i] in the collection
  * nj[j] = number of terms in doc[[j]] (including multiplicities)
  * bi[i] = number of docs in which term[i] occurs at least once
  * bj[j] = number of unique terms in doc[[j]]
  * k[[j]][i] = number of occurrences of term[i] in doc[[j]]



# Preliminaries

```{r}
# Delete all variables initialized in R session, if any
rm(list = ls())

# Load libraries
library(here)
library(rjson)
library(magicaxis)
library(EMT)
library(readr)
library(data.table)

# Set directory relative paths
data_dir <- "data"
input_dir <- "output/simulated-term-in-doc-matrices"
output_dir <- "output/ni-counts"

# Set random seed
set.seed(86472)

# Set plot colors 
gg_color_hue = function(n, alpha = 1) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100, alpha = alpha)[1 : n]
}
cols <- c("grey25", gg_color_hue(n = 3))
tcols <- c("grey25", gg_color_hue(n = 3, alpha = 0.5))
gray25 <- cols[1]; red <- cols[2]; green <- cols[3]; blue <- cols[4]
tred <- cols[2]; tgreen <- tcols[3]; tblue <- tcols[4]
```



# Read Genia Corpus Data and Collected Basic Stats

```{r}
# Read data
infile <- file.path(data_dir, "GENIAcorpus3.02-preprocessed.json")
raw_doc_strings <- fromJSON(paste(readLines(here(infile)), collapse = ""))

# Convert raw doc strings to tokens
d <- length(raw_doc_strings)
raw_docs <- vector("list", length = d)

for (j in 1 : d) {
  raw_docs[[j]] <- strsplit(raw_doc_strings[[j]], split = " +")[[1]]
}
```



```{r}
# Calculate basic stats
d <- length(raw_docs)
nij <- vector(mode = "list", length = d)
doc <- vector(mode = "list", length = d)
all_terms_table <- table(unlist(raw_docs))
all_terms <- names(all_terms_table)
all_term_counts <- as.numeric(all_terms_table)
singleton_terms <- all_terms[which(all_term_counts == 1)]
for (j in 1 : d) {
  mydoc <- raw_docs[[j]]
  #mydoc <- mydoc[!mydoc %in% singleton_terms] # excise singleton terms
  mytable <- sort(table(mydoc), decreasing = T)
  nij[[j]] <- as.numeric(mytable)
  doc[[j]] <- names(mytable)
}
nj <- unlist(lapply(nij, sum))
bj <- unlist(lapply(nij, length))
term <- unique(unlist(doc))
m <- length(term)
n <- sum(unlist(nij))
ni <- table(unlist(raw_docs))[term]
bi <- table(unlist(doc))[term]
bi_unique <- as.numeric(names(table(bi)))
DP <- as.numeric(bi / d)
CP <- as.numeric(ni / n)
IDF <- as.numeric(log(d / bi))
ICF <- as.numeric(log(n / ni))
```




## Collect ni Values Conditional on bi Values

```{r}
set.seed(330972)
R <- 2500
MAX_TOTAL_DRAWS <- 10 ^ 5
MAX_DRAWS <- 25
ni_given_bi_counts <- vector("list", d)

for (r in 1 : R) {
  if (r %% 100 == 0) { print(r) }
  infile_name <- paste0("matrix-", r, ".csv")
  infile <-  file.path(input_dir, infile_name)
  nij_sim <- as.matrix(fread(file = here(infile), header = FALSE))
  ni_sim <- apply(nij_sim, 1, sum)
  ni_sim <- ni_sim[ni_sim != 0] # save computation time by dropping 0 entries
  nij_sim[which(nij_sim > 0)] <- 1
  bi_sim <- apply(nij_sim, 1, sum)
  bi_sim <- bi_sim[bi_sim != 0] # drop 0 entries
  bi_sim_unique <- sort(unique(bi_sim))
  
  for (bi_test in bi_sim_unique) {
    ni_sim_candidates <- ni_sim[which(bi_sim == bi_test)]
    num_of_ni_sim_candidates <- length(ni_sim_candidates)
    
    if (num_of_ni_sim_candidates > MAX_DRAWS) {
       ni_sim_selected <- sample(x = ni_sim_candidates, size = MAX_DRAWS)
    } else {
      ni_sim_selected <- ni_sim_candidates
    }
    
    ni_given_bi_counts[[bi_test]] <- append(ni_given_bi_counts[[bi_test]], ni_sim_selected)
  }
  
  # Output to file
  if (r %% 100 == 0) {
    ni_vector_lengths <- unlist(lapply(ni_given_bi_counts, length))
    bi_nonzero <- which(ni_vector_lengths > 0)
    
    for (bi_test in bi_nonzero) {
      outfile_name <- paste0("ni-given-bi-", bi_test, ".csv")
      outfile <-  file.path(output_dir, outfile_name)
      fwrite(x = list(ni_given_bi_counts[[bi_test]]), file = outfile)
    }
  }
}
```





