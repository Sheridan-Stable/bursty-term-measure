---
title: "Bursty Term P-value Estimation on GENIA Corpus Dataset"
author: "Paul Sheridan"
output: html_notebook
---

## Notation

Variables of note:

  * term[i] = i'th term in vocabulary
  * doc[[j]] = j'th doc in collection (unique terms)
  * d = number of documents in the collection
  * m = vocabulary size
  * n = total number of terms in the collection (including multiplicities) 
  * nij[[j]][i] = total number of occurrences of term[i] in doc[[j]]
  * ni[i] = total number of occurrences of term[i] in the collection
  * nj[j] = number of terms in doc[[j]] (including multiplicities)
  * bi[i] = number of docs in which term[i] occurs at least once
  * bj[j] = number of unique terms in doc[[j]]
  * k[[j]][i] = number of occurrences of term[i] in doc[[j]]



# Preliminaries

```{r}
# Delete all variables initialized in R session, if any
rm(list = ls())

# Load libraries
library(here)
library(tidyverse)
library(jsonlite)
library(data.table)
library(readr)
library(fitdistrplus)
library(OneStep)

# Set directory relative paths
data_dir <- "data"
input_dir <- "output/ni-counts"
output_dir <- "output"
```



# Read Genia Corpus Data and Collected Basic Stats

```{r}
# Read data
infile <- file.path(data_dir, "GENIAcorpus3.02-preprocessed.json")
raw_doc_strings <- fromJSON(paste(readLines(here(infile)), collapse = ""))

# Convert raw doc strings to tokens
d <- length(raw_doc_strings)
raw_docs <- vector("list", length = d)

for (j in 1 : d) {
  raw_docs[[j]] <- strsplit(raw_doc_strings[[j]], split = " +")[[1]]
}
```



```{r}
# Calculate basic stats
d <- length(raw_docs)
nij <- vector(mode = "list", length = d)
doc <- vector(mode = "list", length = d)
all_terms_table <- table(unlist(raw_docs))
all_terms <- names(all_terms_table)
all_term_counts <- as.numeric(all_terms_table)
singleton_terms <- all_terms[which(all_term_counts == 1)]
for (j in 1 : d) {
  mydoc <- raw_docs[[j]]
  #mydoc <- mydoc[!mydoc %in% singleton_terms] # excise singleton terms
  mytable <- sort(table(mydoc), decreasing = T)
  nij[[j]] <- as.numeric(mytable)
  doc[[j]] <- names(mytable)
}
nj <- unlist(lapply(nij, sum))
bj <- unlist(lapply(nij, length))
term <- unique(unlist(doc))
m <- length(term)
n <- sum(unlist(nij))
ni <- as.numeric(table(unlist(raw_docs))[term])
bi <- as.numeric(table(unlist(doc))[term])
bi_unique <- as.numeric(names(table(bi)))
DP <- as.numeric(bi / d)
CP <- as.numeric(ni / n)
IDF <- as.numeric(log(d / bi))
ICF <- as.numeric(log(n / ni))
```


```{r}
# Drop any double quotes from terms
for (i in 1 : m) {
  if(grepl('"', term[i]) == TRUE) {
    print(noquote(term[i]))
    print(noquote(gsub('"', "", term[i])))
    term[i] <- gsub('"', "", term[i])
  }
}
```



# Fit Gamma/Truncated Gamma to Distribution Tails

```{r}
# Used to fit truncated gamma distribution
dtgamma <- function(x, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  dgamma(x, shape, rate) / (PU - PL) * (x >= low) * (x <= upp) 
}

# Used to fit truncated gamma distribution
ptgamma <- function(q, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  (pgamma(q, shape, rate) - PL) / (PU - PL) * (q >= low) * (q <= upp) + 1 * (q > upp)
}
```


```{r}
set.seed(754263)

# Construct list of ni given bi data points
bi_unique <- sort(unique(bi))
number_of_unique_bi_values <- length(bi_unique)
ni_given_bi_counts_lst <- vector("list", d)

for (bi_test in bi_unique) {
  infile_name <- paste0("ni-given-bi-", bi_test, ".csv")
  infile <- file.path(input_dir, infile_name)
  if (file.exists(infile)) {
    ni_given_bi_counts_lst[[bi_test]] <- c(as.matrix(fread(file = here(infile), header = FALSE)))
  }
}

# Calculate number of samples in each case
ni_given_bi_sample_sizes <- unlist(lapply(ni_given_bi_counts_lst, length))
```


```{r}
# Set random seeed
set.seed(104883)

# Fit gamma and truncated gamma distributions to histograms
min_sample_size <- 100
gamma_fits_lst <- vector("list", d)
#tgamma_fits_lst <- vector("list", d)

for (bi_test in bi_unique) {
  # Ensure we have at least 'min_sample_size' samples to fit
  window_size <- 0
  ni_given_bi_sample_size <- ni_given_bi_sample_sizes[bi_test]
  while (ni_given_bi_sample_size < min_sample_size) {
    window_size <- window_size + 1
    ni_given_bi_sample_size <- sum(ni_given_bi_sample_sizes[max(1, bi_test - window_size) : min(bi_test + window_size, d)])
  }
  ni_given_bi_counts <- NULL
  indices <- max(1, bi_test - window_size) : min(bi_test + window_size, d)
  for (index in indices) {
    ni_given_bi_counts <- c(ni_given_bi_counts, ni_given_bi_counts_lst[[index]])
  }
  
  # Fit gamma distribution
  gamma_fits_lst[[bi_test]] <- onestep(ni_given_bi_counts, "gamma")
  
  # Fit truncated gamma distribution
  #shape_init <- as.numeric(gamma_fits_lst[[bi_test]]$estimate['shape'])
  #rate_init <- as.numeric(gamma_fits_lst[[bi_test]]$estimate['rate'])
  #tgamma_fits_lst[[bi_test]] <- fitdist(
  #                                data = ni_given_bi_counts,
  #                                distr = "tgamma",
  #                                method = "mle",
  #                                #start = list(shape = shape_init, rate = rate_init, low = bi_test),
  #                                start = list(shape = 3, rate = 5, low = bi_test),
  #                                fix.arg = list(upp = Inf),
  #                                lower = c(0, 0, -Inf), upper=c(Inf, Inf, min(ni_given_bi_counts)))
}
```



```{r}
# Estimate P-values as gamma distribution tail probability

# Initialize P-value data frame
pvalues_df <- data.frame(
  term = character(m),
  bi = numeric(m),
  ni = numeric(m),
  shape_est = numeric(m),
  rate_est = numeric(m),
  nlog_pval_est = numeric(m)
)

# Estimate P-value for each term
for (i in 1 : m) {
  pvalues_df[i, "term"] <- term[i]
  bi_test <- bi[i]
  pvalues_df[i, "bi"] <- bi_test
  ni_test <- ni[i]
  pvalues_df[i, "ni"] <- ni_test
  shape_est <- as.numeric(gamma_fits_lst[[bi_test]]$estimate['shape'])
  pvalues_df[i, "shape_est"] <- shape_est
  rate_est <- as.numeric(gamma_fits_lst[[bi_test]]$estimate['rate'])
  pvalues_df[i, "rate_est"] <- rate_est
  nlog_pval_est <- -pgamma(q = ni_test, shape = shape_est, rate = rate_est, lower.tail = FALSE, log.p = TRUE)
  pvalues_df[i, "nlog_pval_est"] <- nlog_pval_est
}
```



```{r}
# Write to tsv
outfile_name <- "gamma-pvalues.tsv"
outfile <- file.path(output_dir, outfile_name)
write_tsv(x = pvalues_df, file = outfile)
```



```{r}
mytbl <- tibble(
  term = pvalues_df$term,
  bi = pvalues_df$bi,
  ni = pvalues_df$ni,
  shape_est = pvalues_df$shape_est,
  rate_est = pvalues_df$rate_est,
  nlog_pval_est = pvalues_df$nlog_pval_est
)
mytbl <- mytbl %>% mutate(across(where(is.numeric), round, 2))
mytbl
```











## Extras


```{r}
# Estimate -log(P-value) using the tail of a gamma distribution

fit <- onestep(ni_given_bi_rnd_draws, "gamma")
shape_est <- fit$estimate['shape']
rate_est <- fit$estimate['rate']
nlog_pval_est = -pgamma(q = bi_test, shape = shape_est, rate = rate_est, lower.tail = FALSE, log.p = TRUE)
nlog_pval_est
```

```{r}
set.seed(20230718)
n <- 10000
shape <- 11
rate <- 3
x0 <- 5
x <- rgamma(n, shape = shape, rate = rate)
x <- x[x > x0]
fit <- fitdist(data = x, distr = "tgamma", method = "mle", start = list(shape = shape, rate = rate), fix.arg = list(low = x0, upp = Inf), lower = c(0, 0))
fit
```





```{r}
set.seed(68313)
R <- 2500
theta_hat <- ni / n

for (r in 1 : R) {
  if (r %% 500 == 0) { print(r) }
  outfile_name <- paste0("matrix-", r, ".csv")
  outfile <-  file.path(output_dir, outfile_name)
  nij_sim <- mat.or.vec(nr = m, nc = d)
  
  for (j in 1 : d) {
    nij_sim[, j] <- rmultinom(n = 1, size = nj[j], prob = theta_hat)
  }
  
  write.table(nij_sim, file = here(outfile), row.names = FALSE, col.names = FALSE)
}
```


## Estimate P-value for a Term of Interest

Estimate the P-value for the 1000'th term.
- Use only the first 100 simulated term-in-doc matrices for demonstration purposes. 

```{r}
set.seed(330972)
R <- 100
MAX_TOTAL_DRAWS <- 10 ^ 5
MAX_DRAWS <- 10
ni_given_bi_rnd_draws <- numeric(0)
i <- 1000
bi_test <- bi[1000] # the test statistic

for (r in 1 : R) {
  if (r %% 25 == 0) { print(r) }
  infile_name <- paste0("matrix-", r, ".csv")
  infile <-  file.path(output_dir, infile_name)
  nij_sim <- as.matrix(read.table(file = here(infile)))
  ni_sim <- apply(nij_sim, 1, sum)
  nij_sim[which(nij_sim > 0)] <- 1
  bi_sim <- apply(nij_sim, 1, sum)
  bi_sim_candidate_indices <- which(bi_sim == bi_test)
  ni_sim_candidates <- ni_sim[bi_sim_candidate_indices]
  num_of_ni_sim_candidates <- length(ni_sim_candidates)
  
  if (num_of_ni_sim_candidates > MAX_DRAWS) {
    ni_given_bi_rnd_draws <- c(ni_given_bi_rnd_draws, sample(x = ni_sim_candidates, size = MAX_DRAWS))
  } else {
    ni_given_bi_rnd_draws <- c(ni_given_bi_rnd_draws, ni_sim_candidates)
  }
}
```



```{r}
# Histogram of ni values given bi[i] value
a <- min(ni_given_bi_rnd_draws)
b <- max(ni_given_bi_rnd_draws)
foo = hist(
  ni_given_bi_rnd_draws + 0.001,
  breaks = b - a,
  xaxt = "n",
  freq = FALSE,
  col = "orange",
  panel.first=grid(),
  main = "Histogram of ni",
  xlab = "ni"
)
axis(side = 1, at = foo$mids, labels = seq(a, b))
```


```{r}
# Estimate -log(P-value) using the tail of a gamma distribution
library(OneStep)
fit <- onestep(ni_given_bi_rnd_draws, "gamma")
shape_est <- fit$estimate['shape']
rate_est <- fit$estimate['rate']
nlog_pval_est = -pgamma(q = bi_test, shape = shape_est, rate = rate_est, lower.tail = FALSE, log.p = TRUE)
nlog_pval_est
```





Fitting the truncated gamma distribution doesn't seem to work

Fitting truncated distributions: https://cran.r-project.org/web/packages/fitdistrplus/vignettes/FAQ.html
Tutorial: https://cran.r-project.org/web/packages/fitdistrplus/vignettes/FAQ.html#can-i-fit-truncated-distributions
GitHub issue: https://github.com/aursiber/fitdistrplus/issues/21

```{r}


dtgamma <- function(x, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  dgamma(x, shape, rate) / (PU - PL) * (x >= low) * (x <= upp) 
}

ptgamma <- function(q, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  (pgamma(q, shape, rate) - PL) / (PU - PL) * (q >= low) * (q <= upp) + 1 * (q > upp)
}

set.seed(20230718)
n <- 10000
shape <- 11
rate <- 3
x0 <- 5
x <- rgamma(n, shape = shape, rate = rate)
x <- x[x > x0]
fit <- fitdist(data = x, distr = "tgamma", method = "mle", start = list(shape = shape, rate = rate), fix.arg = list(low = x0, upp = Inf), lower = c(0, 0))
fit
```


```{r}
a <- min(x)
b <- max(x)
foo = hist(
  x + 0.001,
  breaks = b - a,
  xaxt = "n",
  freq = FALSE,
  col = "orange",
  panel.first=grid(),
  main = "Histogram of truncated gamma",
  xlab = "x"
)
axis(side = 1, at = foo$mids, labels = seq(a, b))

shape_est <- f1$estimate[1]
rate_est <- f1$estimate[2]
shape_est <- 11
rate_est <- 5
xfit <- seq(min(x), max(x), length = 10) 
yfit <- dgamma(xfit, shape = shape_est, rate = rate_est) 
yfit <- yfit * diff(foo$mids[1 : 2]) * length(x) 

lines(xfit, yfit, col = "black", lwd = 2)
```


```{r}
plot(xfit, yfit, type = "l")
```


```{r}
library(OneStep)
set.seed(20230723)
n <- 2500
shape <- 11
rate <- 3
x0 <- 5
x <- rgamma(n, shape = shape, rate = rate)
onestep(x, "gamma")
```





## Experiment with distribution of ni

```{r}
set.seed(921012)
R <- 2500
MAX_TOTAL_DRAWS <- 10 ^ 5
MAX_DRAWS <- 10
ni_rnd_draws <- numeric(R)
theta_hat <- ni / n
i <- 1000
print(bi[i])
print(ni[i])

for (r in 1 : R) {
  if (r %% 500 == 0) { print(r) }
  infile_name <- paste0("matrix-", r, ".csv")
  infile <-  file.path(output_dir, infile_name)
  nij_sim <- as.numeric(read.table(file = here(infile), skip = i - 1, nrows = 1))
  ni_sim <- sum(nij_sim)
  bij_sim <- numeric(d)
  bij_sim[which(nij_sim > 0)] <- 1
  bi_sim <- sum(bij_sim)
  
  ni_rnd_draws[r] <- ni_sim
}
```



```{r}
a <- min(ni_rnd_draws)
b <- max(ni_rnd_draws)
foo = hist(
  ni_rnd_draws + 0.001,
  breaks = b - a,
  xaxt = "n",
  freq = FALSE,
  col = "orange",
  panel.first=grid(),
  main = "Histogram of ni",
  xlab = "ni"
)
axis(side = 1, at = foo$mids, labels = seq(a, b))
```


```{r}
length(which(ni_rnd_draws > ni[i]))
mean(ni_rnd_draws)
```























```{r}
library(fitdistrplus)

dtgamma <- function(x, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  dgamma(x, shape, rate) / (PU - PL) * (x >= low) * (x <= upp) 
}

ptgamma <- function(q, shape, rate, low, upp)
{
  PU <- pgamma(upp, shape = shape, rate = rate)
  PL <- pgamma(low, shape = shape, rate = rate)
  (pgamma(q, shape, rate) - PL) / (PU - PL) * (q >= low) * (q <= upp) + 1 * (q > upp)
}
```



```{r}
set.seed(20230718)
n <- 10000
shape <- 11
rate <- 3
x0 <- 5
x <- rgamma(n, shape = shape, rate = rate)
x <- x[x > x0]
fit <- fitdist(
  data = x,
  distr = "tgamma",
  method = "mle",
  start = list(shape = shape, rate = rate),
  fix.arg = list(low = x0, upp = Inf),
  lower = c(0, 0))
fit
```


```{r}
fit.NM.3P <- fitdist(
  data = x,
  distr = "tgamma",
  method = "mle",
  start = list(shape = shape, rate = rate, low = x0),
  fix.arg = list(upp = Inf),
  lower = c(0, 0, -Inf), upper=c(Inf, Inf, min(x)))
coef(fit.NM.3P)
```



